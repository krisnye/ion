{"version":3,"sources":["reactiveTemplates.ion"],"names":["ion","object","x","y","templates","name","a","b","c","z","items","sum",{"type":"Identifier","name":"sum","loc":{"start":{"line":62,"column":12,"fixed":true,"source":"ion/test/reactiveTemplates.ion"},"end":{"line":62,"column":15,"fixed":true,"source":"ion/test/reactiveTemplates.ion"}}},"one","deep","touch","keys","d","aa","alpha","beta","charlie","next","nextId","id","number","index","key","value","lowestBefore","Number","MAX_SAFE_INTEGER","totalComplete","thisArg","templateType","argument","patch","expected","done","beforeCount","observe","count","template","call","finished","unobserve","unobserveValue","afterCount","Math","min","length","checkIfDone","check","JSON","stringify","setTimeout","activate","watchCount","changes","checkForChanges","test"],"mappings":"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","sourcesContent":["const ion = import '../'\n\nconst templates = []\n    []\n        \"regular expression\"\n        {}\n        template (properties) ->\n            return properties.name.replace(/a/g, 'b')\n        {name:\"alpha\"}\n        {}\n        \"blphb\"\n    []\n        \"array comprehension for of\"\n        {}\n        template (properties) ->\n            return [key for key of properties]\n        {a:1,b:2}\n        {b:undefined,c:3}\n        ['a','c']\n    []\n        \"imperative functions\"\n        {}\n        template (properties) ->\n            const double(a) -> a * 2\n            return {}\n                for key, value of properties\n                    [key]: double(value)\n        {x:1,y:2}\n        {x:4,z:3,y:undefined}\n        {x:8,z:6}\n    # []\n    #     \"shared variables functions\"\n    #     {}\n    #     template (properties) ->\n    #         let factor = properties.factor ? 3\n    #         const multiply(a) -> a * factor\n    #         return {}\n    #             for key, value of properties if key isnt 'factor'\n    #                 [key]: multiply(value)\n    #     {x:1,y:2}\n    #     {x:4,y:undefined,z:5,factor:10}\n    #     {x:40,z:50}\n    []\n        \"reactive destructured parameters\"\n        {}\n        template ({a,b}) -> a + b\n        {a:1,b:2}\n        {a:5}\n        7\n    []\n        \"array comprehension for in\"\n        {}\n        template ({items}) -> [x + i for x, i in items]\n        {items:[1,2,3]}\n        {items:{3:4}}\n        [1,3,5,7]\n    []\n        \"changing object with function\"\n        {}\n        template (object) -> object.sum()\n        {}\n            sum: -> @x + @y\n            x: 1\n            y: 2\n        {}\n            x: 6\n        8\n    []\n        \"nested templates\"\n        {}\n        do ->\n            return template (object) ->\n                let factor = 2\n                let sum = template ({deep:{a,b}}) ->\n                    return (a + b) * factor\n                return sum(object.one)\n        {}\n            one:\n                deep:\n                    a: 1\n                    b: 2\n        {}\n            one:\n                deep:\n                    a: 2\n        8\n    []\n        \"literal objects\"\n        {}\n        template () ->\n            return {touch:1,\"touch-start\":2}\n        {}\n        {}\n        {touch:1,\"touch-start\":2}\n    []\n        \"this\"\n        let object = {x:1,y:2}\n        object\n        template -> this.x + this.y\n        object\n        {x:10}\n        12\n    []\n        \"correct ordering of array items\"\n        {}\n        template (object) ->\n            return [1,2]\n                if object.a\n                    \"Alpha\"\n                \"Beta\"\n                for key of object.keys\n                    key\n                \"Charlie\"\n                for item in object.items\n                    item\n                \"Delta\"\n        {}\n            a: false\n            keys: {c:1,b:2,a:3}\n            items: [3,2,1]\n        {}\n            a: true\n            keys:\n                c: undefined\n                d: 4\n                aa: 1\n            items:\n                0: 4\n        [1, 2, \"Alpha\", \"Beta\", \"b\", \"a\", \"d\", \"aa\", \"Charlie\", 4, 2, 1, \"Delta\"]\n    do ->\n        # this test verifies that statements are reused when a value shifts within an array\n        let alpha = 100\n        let beta = 200\n        let charlie = 300\n        let next = 0\n        let nextId = -> next++\n        return []\n            \"for in reuse values\"\n            {}\n            template (items) ->\n                return []\n                    for item, index in items\n                        { id: nextId(), number: item, index: index }\n            [alpha,beta,charlie]\n            {0:charlie,1:alpha,2:undefined}\n            [{id:2,number:charlie,index:0},{id:0,number:alpha,index:1}]\n    do ->\n        # this test verifies that statements are reused when a key shifts within an object\n        let next = 0\n        let nextId = -> next++\n        return []\n            \"for of reuse keys\"\n            {}\n            template (items) ->\n                return []\n                    for key, value of items\n                        { id: nextId(), key: key, value: value }\n            {alpha:1,beta:2,charlie:3}\n            {beta:3,charlie:undefined}\n            [{id:0,key:'alpha',value:1},{id:1,key:'beta',value:3}]\n    []\n        \"deep args\"\n        {}\n        template (object) -> JSON.stringify(deep object)\n        {}\n            z:\n                b: 2\n        {}\n            z:\n                b: 20\n        '{\"z\":{\"b\":20}}'\n\nexport\n    test:\n        let lowestBefore = Number.MAX_SAFE_INTEGER\n        let totalComplete = 0\n        for [name, thisArg, templateType,argument,patch,expected] in templates if expected?\n            [name]: do (thisArg, templateType, argument, patch, expected) ->\n                return (done) ->\n                    let beforeCount = ion.observe.count ? 0\n                    let template = templateType.call(thisArg, argument)\n                    const finished = ->\n                        unobserve()\n                        unobserveValue?()\n                        let afterCount = ion.observe.count ? 0\n                        # console.log({beforeCount,watchCount,afterCount})\n                        totalComplete++\n                        lowestBefore = Math.min(beforeCount, lowestBefore)\n                        if totalComplete is templates.length and afterCount > lowestBefore\n                            done(\"ion.observe memory leak detected, beforeCount: {{lowestBefore}}, afterCount: {{afterCount}}\")\n                        else\n                            done()\n\n                    const checkIfDone (check) ->\n                        # console.log(JSON.stringify({check,expected,argument}))\n                        if JSON.stringify(check) is JSON.stringify(expected)\n                            # in case of immediate response, unobserve may not have been set yet\n                            if unobserve?\n                                finished()\n                            else\n                                setTimeout(finished, 0)\n                    template.activate()\n                    let watchCount = ion.observe.count ? 0\n                    let unobserveValue\n                    let unobserve = template.observe(\n                        (value) ->\n                            checkIfDone(value)\n                            unobserveValue?()\n                            unobserveValue = ion.observe(\n                                value\n                                (changes) ->\n                                    checkIfDone(value)\n                            )\n                    )\n                    # console.log('==========================================================')\n                    ion.patch(argument, patch)\n                    # console.log('just patched')\n                    # console.log(JSON.stringify({expected,argument}))\n                    ion.checkForChanges()\n"]}